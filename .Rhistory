attach(barrera)
check_table <- table(T1T2T3, T1_treat, T2_treat, T3_treat)
ftable(check_table)
# Filtering data in line with the following STATA code operations to reproduce table 3, columns 1-3:
# Dropping ineligible cases from Suba: Drop if suba == 1 and grade is < 9
# drop if suba == 1 & grade < 9;
# The above seems to be a mistake in the STATA code: this should be grade < 6 instead of < 9.
# Keeping only those who were selected for the survey:
# keep if survey_selected;
# Drop if they are in grade 11
# Filtered data
filtered_barrera <- barrera %>% filter(suba == 0, grade >= 6, survey_selected == 1, grade != 11)
# Filtering data in line with the following STATA code operations to reproduce table 3, columns 4-6:
# Same as above, but suba == 1 and in rade 9 or 10
filtered_barrera2 <- barrera %>% filter(suba == 1, survey_selected == 1, grade >= 9, grade <= 10)
# Table 1
# Using n = 5,799 to get the sample actually used in our model (for columns 1-3). Variables selected based on Table 1.
# Note: Some factor variables are presented in the paper as scale vars.
# House posessions - f_teneviv
# utilities - s_utilities
# durable goods - s_durables
# physical infrastructure - s_infraest_hh
# age - s_age_sorteo
# gender - s_sexo
# years of education - s_yrs
# single head - s_single
# Age of head - s_edadhead
# years of ed head - s_yrshead
# people in household - s_tpersona
# Member under 18 - s_num18
# estrato - f_estrato
# SISBEN - s_puntaje
# household income - s_ingtotal
table1 <- table1(~ factor(f_teneviv) + s_utilities + s_durables + s_infraest_hh + s_age_sorteo + factor(f_sexo) + s_yrs + factor(f_single) + s_edadhead + s_yrshead + s_tpersona + s_num18 + factor(f_estrato) + s_puntaje + s_ingtotal | ~ factor(T1T2T3), data=filtered_barrera)
View(filtered_barrera)
View(filtered_barrera)
table1 <- table1(~ factor(f_teneviv) + factor(s_utilities) + s_durables + s_infraest_hh + s_age_sorteo + factor(f_sexo) + s_yrs + factor(f_single) + s_edadhead + s_yrshead + s_tpersona + s_num18 + factor(f_estrato) + s_puntaje + s_ingtotal | ~ factor(T1T2T3), data=filtered_barrera)
model3 <- lm(data = filtered_barrera, at_msamean ~ T1T2T3 + s_teneviv + s_utilities + s_durables + s_infraest_hh + s_age_sorteo + s_age_sorteo2 + s_years_back + s_sexo + s_estcivil + s_single + s_edadhead + s_yrshead + s_tpersona + s_num18 + s_estrato + s_puntaje + s_ingtotal + s_grade + suba + s_over_age)
model3 <- lm(data = filtered_barrera, at_msamean ~ T1T2T3 + s_teneviv + s_utilities + s_durables + s_infraest_hh + s_age_sorteo + s_age_sorteo2 + s_years_back + s_sexo + s_estcivil + s_single + s_edadhead + s_yrshead + s_tpersona + s_num18 + s_estrato + s_puntaje + s_ingtotal + grade + suba + s_over_age)
tidy(model3, conf.int = TRUE)
# Plug the original data into the model and find fitted values and
# residuals/errors
fitted_data <- augment(model3, data = filtered_barrera)
# Look at relationship between fitted values and residuals
ggplot(fitted_data, aes(x = .fitted, y = .resid)) +
geom_point(aes(color = T1T2T3)) +
geom_smooth(method = "lm")
model3 <- lm(data = filtered_barrera, at_msamean ~ T1T2T3 + s_teneviv + s_utilities + s_durables + s_infraest_hh + s_age_sorteo + s_age_sorteo2 + s_years_back + s_sexo + s_estcivil + s_single + s_edadhead + s_yrshead + s_tpersona + s_num18 + s_estrato + s_puntaje + s_ingtotal + grade + suba + s_over_age + factor(school_code))
tidy(model3, conf.int = TRUE)
# Plug the original data into the model and find fitted values and
# residuals/errors
fitted_data <- augment(model3, data = filtered_barrera)
# Look at relationship between fitted values and residuals
ggplot(fitted_data, aes(x = .fitted, y = .resid)) +
geom_point(aes(color = T1T2T3)) +
geom_smooth(method = "lm")
model3 <- lm(data = filtered_barrera, at_msamean ~ factor(T1T2T3) + s_teneviv + s_utilities + s_durables + s_infraest_hh + s_age_sorteo + s_age_sorteo2 + s_years_back + s_sexo + s_estcivil + s_single + s_edadhead + s_yrshead + s_tpersona + s_num18 + s_estrato + s_puntaje + s_ingtotal + grade + suba + s_over_age + factor(school_code))
tidy(model3, conf.int = TRUE)
# Plug the original data into the model and find fitted values and
# residuals/errors
fitted_data <- augment(model3, data = filtered_barrera)
# Look at relationship between fitted values and residuals
ggplot(fitted_data, aes(x = .fitted, y = .resid)) +
geom_point(aes(color = T1T2T3)) +
geom_smooth(method = "lm")
tidy(mod3)
# Model 3
mod3 <- lm.cluster(data = filtered_barrera, at_msamean ~ T1_treat + T2_treat + f_teneviv + s_utilities + s_durables + s_infraest_hh + s_age_sorteo + s_age_sorteo2 + s_years_back + s_sexo + f_estcivil + s_single + s_edadhead + s_yrshead + s_tpersona + s_num18 + f_estrato + s_puntaje + s_ingtotal + f_grade + suba + s_over_age + factor(school_code),  cluster = "school_code")
#library(knitrBootstrap)
library(dplyr)
# reading STATA files
library(haven)
library(table1)
# lm.cluster function
library(lmtest)
library(miceadds)
library(ggplot2)
library(sandwich)
# visualise residuals for clustered regression
library(visreg)
library(tidyverse)       # For ggplot, dplyr, and friends
library(broom)           # Convert model objects into data frames
barrera <- read_dta("data/Public_Data_AEJApp_2010-0132.dta")
barrera$f_teneviv <- factor(barrera$s_teneviv)
barrera$f_estcivil <- factor(barrera$s_estcivil, levels = c(1, 2, 3, 4, 5), labels = c("Free union", "Married", "Widow(er)", "Divorced", "Single"))
barrera$f_estrato <- factor(barrera$s_estrato)
barrera$f_grade <- factor(barrera$grade)
barrera$f_sexo <- factor(barrera$s_sexo, levels = c(0,1), labels = c("Female", "Male"))
barrera$f_single <- factor(barrera$s_single, levels = c(0,1), labels = c("No", "Yes"))
barrera$f_over_age <- factor(barrera$s_over_age, levels = c(0,1), labels = c("No", "Yes"))
barrera$f_suba <- factor(barrera$suba, levels = c(0,1), labels = c("San Cristobal", "Suba"))
barrera$T1T2T3 <- case_when(
barrera$T1_treat == 1 ~ 1,
barrera$T2_treat == 1 ~ 2,
barrera$T3_treat == 1 ~ 3,
barrera$T1_treat == 0 & barrera$T2_treat == 0 & barrera$T3_treat == 0 ~ 0
)
barrera$T1T2T3 <- factor(barrera$T1T2T3, level = c(0, 1, 2, 3), labels = c("Control", "Basic (T1)", "Savings (T2)", "Tertiary (T3"))
attach(barrera)
check_table <- table(T1T2T3, T1_treat, T2_treat, T3_treat)
ftable(check_table)
filtered_barrera <- barrera %>% filter(suba == 0, grade >= 6, survey_selected == 1, grade != 11)
filtered_barrera2 <- barrera %>% filter(suba == 1, survey_selected == 1, grade >= 9, grade <= 10)
table1 <- table1(~ factor(f_teneviv) + s_utilities + s_durables + s_infraest_hh + s_age_sorteo + factor(f_sexo) + s_yrs + factor(f_single) + s_edadhead + s_yrshead + s_tpersona + s_num18 + factor(f_estrato) + s_puntaje + s_ingtotal | ~ factor(T1T2T3), data=filtered_barrera)
mod1 <- lm.cluster(data = filtered_barrera, at_msamean ~ T1_treat + T2_treat,  cluster = "school_code")
#mod1 <- lm(data = filtered_barrera, at_msamean ~ T1_treat + T2_treat)
summary(mod1)
# Model 2
mod2 <- lm.cluster(data = filtered_barrera, at_msamean ~ T1_treat + T2_treat + f_teneviv + s_utilities + s_durables + s_infraest_hh + s_age_sorteo + s_age_sorteo2 + s_years_back + s_sexo + f_estcivil + s_single + s_edadhead + s_yrshead + s_tpersona + s_num18 + f_estrato + s_puntaje + s_ingtotal + f_grade + suba + s_over_age,  cluster = "school_code")
summary(mod2)
# Model 3
mod3 <- lm.cluster(data = filtered_barrera, at_msamean ~ T1_treat + T2_treat + f_teneviv + s_utilities + s_durables + s_infraest_hh + s_age_sorteo + s_age_sorteo2 + s_years_back + s_sexo + f_estcivil + s_single + s_edadhead + s_yrshead + s_tpersona + s_num18 + f_estrato + s_puntaje + s_ingtotal + f_grade + suba + s_over_age + factor(school_code),  cluster = "school_code")
tidy(mod3)
ggplot(fitted_data, aes(x = .resid)) +
geom_histogram(binwidth = 100, color = "white", boundary = 3000)
ggplot(fitted_data, aes(x = .resid)) +
geom_histogram(binwidth = 1, color = "white", boundary = 3000)
ggplot(fitted_data, aes(x = .resid)) +
geom_histogram(binwidth = 1, color = "white", boundary = 25000)
ggplot(fitted_data, aes(x = .resid)) +
geom_histogram(binwidth = 10, color = "white", boundary = 25000)
ggplot(fitted_data, aes(x = .resid)) +
geom_histogram(binwidth = 100000, color = "white", boundary = 25000)
ggplot(fitted_data, aes(x = .resid)) +
geom_histogram(binwidth = 0.1, color = "white", boundary = 25000)
ggplot(fitted_data, aes(x = .resid)) +
geom_histogram(binwidth = 0.001, color = "white", boundary = 25000)
ggplot(fitted_data, aes(x = .resid)) +
geom_histogram(binwidth = 0.01, color = "white", boundary = 25000)
ggplot(fitted_data, aes(x = .resid)) +
geom_histogram(binwidth = 0.01, color = "white", boundary = 50000)
model3_t1 <- lm(data = filtered_barrera, at_msamean ~ T1_treat + s_teneviv + s_utilities + s_durables + s_infraest_hh + s_age_sorteo + s_age_sorteo2 + s_years_back + s_sexo + s_estcivil + s_single + s_edadhead + s_yrshead + s_tpersona + s_num18 + s_estrato + s_puntaje + s_ingtotal + grade + suba + s_over_age + factor(school_code))
model3_t2 <- lm(data = filtered_barrera, at_msamean ~ T2_treat + s_teneviv + s_utilities + s_durables + s_infraest_hh + s_age_sorteo + s_age_sorteo2 + s_years_back + s_sexo + s_estcivil + s_single + s_edadhead + s_yrshead + s_tpersona + s_num18 + s_estrato + s_puntaje + s_ingtotal + grade + suba + s_over_age + factor(school_code))
# Plug the original data into the model and find fitted values and
# residuals/errors
fitted_data <- augment(model3, data = filtered_barrera)
fitted_t1 <- augment(model3_t1, data = filtered_barrera)
fitted_t2 <- augment(model3, data = filtered_barrera)
ggplot(fitted_data_t1, aes(x = .fitted, y = .resid)) +
geom_point(aes(color = T1_treat)) +
geom_smooth(method = "lm")
fitted_t1 <- augment(model3_t1, data = filtered_barrera)
ggplot(fitted_t1, aes(x = .fitted, y = .resid)) +
geom_point(aes(color = T1_treat)) +
geom_smooth(method = "lm")
model3_t1 <- lm(data = filtered_barrera, at_msamean ~ T1_treat + s_teneviv + s_utilities + s_durables + s_infraest_hh + s_age_sorteo + s_age_sorteo2 + s_years_back + s_sexo + s_estcivil + s_single + s_edadhead + s_yrshead + s_tpersona + s_num18 + s_estrato + s_puntaje + s_ingtotal + grade + suba + s_over_age))
model3_t1 <- lm(data = filtered_barrera, at_msamean ~ T1_treat + s_teneviv + s_utilities + s_durables + s_infraest_hh + s_age_sorteo + s_age_sorteo2 + s_years_back + s_sexo + s_estcivil + s_single + s_edadhead + s_yrshead + s_tpersona + s_num18 + s_estrato + s_puntaje + s_ingtotal + grade + suba + s_over_age)
fitted_t1 <- augment(model3_t1, data = filtered_barrera)
ggplot(fitted_t1, aes(x = .fitted, y = .resid)) +
geom_point(aes(color = T1_treat)) +
geom_smooth(method = "lm")
plot(filtered_barrera$at_msamean)
plot(filtered_barrera$at_msamean)
plot(filtered_barrera$at_msamean, T1_treat)
plot(filtered_barrera$at_msamean, by T1_treat)
plot(filtered_barrera$at_msamean, by = T1_treat)
ggplot(fitted_data, aes(x = .resid)) +
geom_histogram(binwidth = 0.01, color = "white", boundary = 50000)
ggplot(filtered_barrera, aes(x = T1T2T3, y = as_msamean)) +
geom_boxplot() +    # Box plot for visualization
labs(x = "Factor variable", y = "as_msemean")  # Label the axes
ggplot(filtered_barrera, aes(x = T1T2T3, y = as_msamean)) +
geom_boxplot() +    # Box plot for visualization
labs(x = "Factor variable", y = "as_msemean")  # Label the axes
ggplot(filtered_barrera, aes(x = T1T2T3, y = at_msamean)) +
geom_boxplot() +    # Box plot for visualization
labs(x = "Factor variable", y = "as_msemean")  # Label the axes
ggplot(filtered_barrera, aes(x = T1T2T3, y = at_msamean)) +
geom_boxplot() +    # Box plot for visualization
labs(x = "Treatment", y = "Attendance %")  # Label the axes
model3b <- glm(data = filtered_barrera, at_msamean ~ factor(T1T2T3) + s_teneviv + s_utilities + s_durables + s_infraest_hh + s_age_sorteo + s_age_sorteo2 + s_years_back + s_sexo + s_estcivil + s_single + s_edadhead + s_yrshead + s_tpersona + s_num18 + s_estrato + s_puntaje + s_ingtotal + grade + suba + s_over_age + factor(school_code))
tidy(model3b, conf.int = TRUE)
?glm
sumarry(model3b)
summary(model3b)
model3b <- glm(data = filtered_barrera, family = Gamma,at_msamean ~ factor(T1T2T3) + s_teneviv + s_utilities + s_durables + s_infraest_hh + s_age_sorteo + s_age_sorteo2 + s_years_back + s_sexo + s_estcivil + s_single + s_edadhead + s_yrshead + s_tpersona + s_num18 + s_estrato + s_puntaje + s_ingtotal + grade + suba + s_over_age + factor(school_code))
summary(filtered_barrera)
model3b <- glm(data = filtered_barrera, family = Gamma, at_msamean ~ factor(T1T2T3) + s_teneviv + s_utilities + s_durables + s_infraest_hh + s_age_sorteo + s_age_sorteo2 + s_years_back + s_sexo + s_estcivil + s_single + s_edadhead + s_yrshead + s_tpersona + s_num18 + s_estrato + s_puntaje + s_ingtotal + grade + suba + s_over_age + factor(school_code))
tidy(model3b, conf.int = TRUE)
model3 <- glm(formula = at_msamean ~ factor(T1T2T3) + s_teneviv + s_utilities + s_durables + s_infraest_hh + s_age_sorteo + s_age_sorteo2 + s_years_back + s_sexo + s_estcivil + s_single + s_edadhead + s_yrshead + s_tpersona + s_num18 + s_estrato + s_puntaje + s_ingtotal + grade + suba + s_over_age + factor(school_code),
data = filtered_barrera,
family = Gamma())
tidy(model3b, conf.int = TRUE)
model3 <- glm(formula = at_msamean ~ factor(T1T2T3) + s_teneviv + s_utilities + s_durables + s_infraest_hh + s_age_sorteo + s_age_sorteo2 + s_years_back + s_sexo + s_estcivil + s_single + s_edadhead + s_yrshead + s_tpersona + s_num18 + s_estrato + s_puntaje + s_ingtotal + grade + suba + s_over_age + factor(school_code),
data = filtered_barrera,
family = inverse.gaussian())
model3 <- glm(formula = at_msamean ~ factor(T1T2T3) + s_teneviv + s_utilities + s_durables + s_infraest_hh + s_age_sorteo + s_age_sorteo2 + s_years_back + s_sexo + s_estcivil + s_single + s_edadhead + s_yrshead + s_tpersona + s_num18 + s_estrato + s_puntaje + s_ingtotal + grade + suba + s_over_age + factor(school_code),
data = filtered_barrera,
family = binomial())
model3 <- glm(formula = at_msamean ~ factor(T1T2T3) + s_teneviv + s_utilities + s_durables + s_infraest_hh + s_age_sorteo + s_age_sorteo2 + s_years_back + s_sexo + s_estcivil + s_single + s_edadhead + s_yrshead + s_tpersona + s_num18 + s_estrato + s_puntaje + s_ingtotal + grade + suba + s_over_age + factor(school_code),
data = filtered_barrera,
family = poisson())
model3 <- glm(formula = at_msamean ~ factor(T1T2T3) + s_teneviv + s_utilities + s_durables + s_infraest_hh + s_age_sorteo + s_age_sorteo2 + s_years_back + s_sexo + s_estcivil + s_single + s_edadhead + s_yrshead + s_tpersona + s_num18 + s_estrato + s_puntaje + s_ingtotal + grade + suba + s_over_age + factor(school_code),
data = filtered_barrera,
family = Gamma(link = "log"))
log(at_msamean)
at_msamean
summary(filtered_barrera$at_msamean)
hist(filtered_barrera$at_msamean)
# Create a histogram of at_msamean by T1T2T3
ggplot(filtered_barrera, aes(x = at_msamean, fill = factor(T1T2T3))) +
geom_histogram(binwidth = 1, alpha = 0.5, position = "identity") +
labs(x = "at_msamean", y = "Frequency", fill = "T1T2T3")
# Create separate histograms of at_msamean for each level of T1T2T3
ggplot(filtered_barrera, aes(x = at_msamean)) +
geom_histogram(binwidth = 1, alpha = 0.5, position = "identity") +
labs(x = "at_msamean", y = "Frequency") +
facet_wrap(~T1T2T3, ncol = 3)
# Create separate histograms of at_msamean for each level of T1T2T3
ggplot(filtered_barrera, aes(x = at_msamean)) +
geom_histogram(binwidth = 0.01, alpha = 0.5, position = "identity") +
labs(x = "at_msamean", y = "Frequency") +
facet_wrap(~T1T2T3, ncol = 3)
# Create separate histograms of at_msamean for each level of T1T2T3
ggplot(filtered_barrera, aes(x = at_msamean)) +
geom_histogram(binwidth = 0.05, alpha = 0.5, position = "identity") +
labs(x = "at_msamean", y = "Frequency") +
facet_wrap(~T1T2T3, ncol = 3)
# Create separate histograms of at_msamean for each level of T1T2T3
ggplot(filtered_barrera, aes(x = at_msamean)) +
geom_histogram(binwidth = 0.05, alpha = 0.5, position = "identity") +
labs(x = "Attendance %", y = "Frequency") +
facet_wrap(~T1T2T3, ncol = 3)
# Create separate histograms of at_msamean for each level of T1T2T3
ggplot(filtered_barrera, aes(x = at_msamean)) +
geom_histogram(binwidth = 0.05, alpha = 0.5, position = "identity") +
labs(x = "Attendance %", y = "Frequency") +
facet_wrap(~T1T2T3, ncol = 3) +
geom_vline(xintercept = 0.8, color = "red", linetype = "dashed")
# Create separate histograms of at_msamean for each level of T1T2T3
ggplot(filtered_barrera, aes(x = at_msamean)) +
geom_histogram(binwidth = 0.05, alpha = 0.5, position = "identity") +
labs(x = "Attendance %", y = "Frequency") +
facet_wrap(~T1T2T3, ncol = 3) +
geom_vline(xintercept = 0.8, color = "red", linetype = "dashed")+
theme(panel.border = element_rect(colour = "black", fill = NA, size = 1),
panel.spacing = unit(0.5, "lines"))
# Create separate histograms of at_msamean for each level of T1T2T3
ggplot(filtered_barrera, aes(x = at_msamean)) +
geom_histogram(binwidth = 0.02, alpha = 0.5, position = "identity") +
labs(x = "Attendance %", y = "Frequency") +
facet_wrap(~T1T2T3, ncol = 3) +
geom_vline(xintercept = 0.8, color = "red", linetype = "dashed")+
theme(panel.border = element_rect(colour = "black", fill = NA, size = 1),
panel.spacing = unit(0.5, "lines"))
# Create separate histograms of at_msamean for each level of T1T2T3
ggplot(filtered_barrera, aes(x = at_msamean)) +
geom_histogram(binwidth = 0.07, alpha = 0.5, position = "identity") +
labs(x = "Attendance %", y = "Frequency") +
facet_wrap(~T1T2T3, ncol = 3) +
geom_vline(xintercept = 0.8, color = "red", linetype = "dashed")+
theme(panel.border = element_rect(colour = "black", fill = NA, size = 1),
panel.spacing = unit(0.5, "lines"))
# Create separate density plots of at_msamean for each level of T1T2T3
ggplot(filtered_barrera, aes(x = at_msamean)) +
geom_density(aes(fill = T1T2T3), alpha = 0.5) +
labs(x = "at_msamean", y = "Density") +
facet_wrap(~T1T2T3, ncol = 3) +
geom_vline(xintercept = 0.8, color = "red", linetype = "dashed") +
theme(panel.border = element_rect(colour = "black", fill = NA, size = 1),
panel.spacing = unit(0.5, "lines"))
# Create separate cumulative histograms of at_msamean for each level of T1T2T3
ggplot(filtered_barrera, aes(x = at_msamean, group = T1T2T3, fill = T1T2T3)) +
stat_bin(binwidth = 1, geom = "step", cumulative = TRUE, position = "identity", alpha = 0.5) +
labs(x = "at_msamean", y = "Cumulative Frequency") +
facet_wrap(~T1T2T3, ncol = 3) +
geom_vline(xintercept = 0.8, color = "red", linetype = "dashed") +
theme(panel.border = element_rect(colour = "black", fill = NA, size = 1),
panel.spacing = unit(0.5, "lines"))
# Create separate cumulative histograms of at_msamean for each level of T1T2T3
ggplot(filtered_barrera, aes(x = at_msamean, group = T1T2T3, fill = T1T2T3)) +
stat_bin(binwidth = 0.01, geom = "step", cumulative = TRUE, position = "identity", alpha = 0.5) +
labs(x = "at_msamean", y = "Cumulative Frequency") +
facet_wrap(~T1T2T3, ncol = 3) +
geom_vline(xintercept = 0.8, color = "red", linetype = "dashed") +
theme(panel.border = element_rect(colour = "black", fill = NA, size = 1),
panel.spacing = unit(0.5, "lines"))
# Create separate cumulative histograms of at_msamean for each level of T1T2T3
ggplot(filtered_barrera, aes(x = at_msamean, group = T1T2T3, fill = T1T2T3)) +
stat_bin(binwidth = 0.01, geom = "step", cumulative = TRUE, position = "identity", alpha = 0.5) +
labs(x = "at_msamean", y = "Cumulative Frequency") +
facet_wrap(~T1T2T3, ncol = 3) +
geom_vline(xintercept = 0.8, color = "red", linetype = "dashed") +
theme(panel.border = element_rect(colour = "black", fill = NA, size = 1),
panel.spacing = unit(0.5, "lines"))
# Create separate density plots of at_msamean for each level of T1T2T3
ggplot(filtered_barrera, aes(x = at_msamean)) +
geom_density(aes(fill = T1T2T3), alpha = 0.5) +
labs(x = "at_msamean", y = "Density") +
facet_wrap(~T1T2T3, ncol = 3) +
geom_vline(xintercept = 0.8, color = "red", linetype = "dashed") +
theme(panel.border = element_rect(colour = "black", fill = NA, size = 1),
panel.spacing = unit(0.5, "lines"))
# Create separate density plots of at_msamean for each level of T1T2T3
ggplot(filtered_barrera, aes(x = at_msamean)) +
stat_ecdf(aes(color = T1T2T3)) +
labs(x = "at_msamean", y = "Cumulative Probability") +
facet_wrap(~T1T2T3, ncol = 3) +
geom_vline(xintercept = 0.8, color = "red", linetype = "dashed") +
theme(panel.border = element_rect(colour = "black", fill = NA, size = 1),
panel.spacing = unit(0.5, "lines"))
cutoff <- 0.8  # set the cutoff value
filtered_barrera %>%
group_by(T1T2T3) %>%
summarize(prop_above_cutoff = sum(at_msamean >= cutoff) / n())
cutoff <- 0.8  # set the cutoff value
filtered_barrera %>%
group_by(T1T2T3) %>%
summarize(prop_cutoff = sum(at_msamean >= cutoff) / n())
filtered_barrera <- filtered_barrera %>%
mutate(above_cutoff = ifelse(at_msamean >= cutoff, "Above", "Below"))
filtered_barrera <- filtered_barrera %>%
mutate(above_cutoff = ifelse(at_msamean >= cutoff, 1, 0))
mod3 <- lm.cluster(data = filtered_barrera, above_cutoff ~ T1_treat + T2_treat + f_teneviv + s_utilities + s_durables + s_infraest_hh + s_age_sorteo + s_age_sorteo2 + s_years_back + s_sexo + f_estcivil + s_single + s_edadhead + s_yrshead + s_tpersona + s_num18 + f_estrato + s_puntaje + s_ingtotal + f_grade + suba + s_over_age + factor(school_code),  cluster = "school_code")
sum(mod3)
mod3 <- lm.cluster(data = filtered_barrera, above_cutoff ~ T1_treat + T2_treat + f_teneviv + s_utilities + s_durables + s_infraest_hh + s_age_sorteo + s_age_sorteo2 + s_years_back + s_sexo + f_estcivil + s_single + s_edadhead + s_yrshead + s_tpersona + s_num18 + f_estrato + s_puntaje + s_ingtotal + f_grade + suba + s_over_age + factor(school_code),  cluster = "school_code")
summary(mod3)
fitted_data <- augment(mod3, data = filtered_barrera)
# Running above model but with this as outcome
library(clusterSEs)
# Running above model but with this as outcome
library(clusterSEs) # to get augment method for lm.cluster
filtered_barrera <- filtered_barrera %>%
mutate(above_cutoff = ifelse(at_msamean >= cutoff, 1, 0))
# Running above model but with this as outcome
library(clusterSEs) # to get augment method for lm.cluster
mod3 <- lm.cluster(data = filtered_barrera, above_cutoff ~ T1_treat + T2_treat + f_teneviv + s_utilities + s_durables + s_infraest_hh + s_age_sorteo + s_age_sorteo2 + s_years_back + s_sexo + f_estcivil + s_single + s_edadhead + s_yrshead + s_tpersona + s_num18 + f_estrato + s_puntaje + s_ingtotal + f_grade + suba + s_over_age + factor(school_code),  cluster = "school_code")
summary(mod3)
fitted_data <- augment(mod3, data = filtered_barrera)
# Running above model but with this as outcome
library(clusterSEs) # to get augment method for lm.cluster
?clusterSEs
# Look at relationship between fitted values and residuals
ggplot(fitted_data, aes(x = .fitted, y = .resid)) +
geom_point(aes(color = school_code)) +
geom_smooth(method = "lm")
# robust standard errors with fixest
library(fixest)
# Because species comes after |, it's being treated as a fixed effect
model_feols <- lm(at_msamean ~ factor(T1T2T3) + s_teneviv + s_utilities + s_durables + s_infraest_hh + s_age_sorteo + s_age_sorteo2 + s_years_back + s_sexo + s_estcivil + s_single + s_edadhead + s_yrshead + s_tpersona + s_num18 + s_estrato + s_puntaje + s_ingtotal + grade + suba + s_over_age + factor(school_code) | school_code,
vcov = "hetero",
data = filtered_barrera)
# Because species comes after |, it's being treated as a fixed effect
model_feols <- lm(at_msamean ~ T1T2T3 + s_teneviv + s_utilities + s_durables + s_infraest_hh + s_age_sorteo + s_age_sorteo2 + s_years_back + s_sexo + s_estcivil + s_single + s_edadhead + s_yrshead + s_tpersona + s_num18 + s_estrato + s_puntaje + s_ingtotal + grade + suba + s_over_age + factor(school_code) | school_code,
vcov = "hetero",
data = filtered_barrera)
# Because species comes after |, it's being treated as a fixed effect
model_feols <- lm(at_msamean ~ T1T2T3 + s_teneviv + s_utilities + s_durables + s_infraest_hh + s_age_sorteo + s_age_sorteo2 + s_years_back + s_sexo + s_estcivil + s_single + s_edadhead + s_yrshead + s_tpersona + s_num18 + s_estrato + s_puntaje + s_ingtotal + grade + suba + s_over_age + factor(school_code) | school_code,
cluster = ~ school_code,
data = filtered_barrera)
# Because species comes after |, it's being treated as a fixed effect
model_feols <- feols(at_msamean ~ T1T2T3 + s_teneviv + s_utilities + s_durables + s_infraest_hh + s_age_sorteo + s_age_sorteo2 + s_years_back + s_sexo + s_estcivil + s_single + s_edadhead + s_yrshead + s_tpersona + s_num18 + s_estrato + s_puntaje + s_ingtotal + grade + suba + s_over_age + factor(school_code) | school_code,
cluster = ~ school_code,
data = filtered_barrera)
# Because species comes after |, it's being treated as a fixed effect
model_feols <- feols(at_msamean ~ T1_treat + T2_treat + s_teneviv + s_utilities + s_durables + s_infraest_hh + s_age_sorteo + s_age_sorteo2 + s_years_back + s_sexo + s_estcivil + s_single + s_edadhead + s_yrshead + s_tpersona + s_num18 + s_estrato + s_puntaje + s_ingtotal + grade + suba + s_over_age + factor(school_code) | school_code,
cluster = ~ school_code,
data = filtered_barrera)
$collin.var
# Because species comes after |, it's being treated as a fixed effect
model_feols <- feols(at_msamean ~ T1_treat + T2_treat + s_teneviv + s_utilities + s_durables + s_infraest_hh + s_age_sorteo + s_age_sorteo2 + s_years_back + s_sexo + s_estcivil + s_single + s_edadhead + s_yrshead + s_tpersona + s_num18 + s_estrato + s_puntaje + s_ingtotal + grade + suba + s_over_age + school_code | school_code,
cluster = ~ school_code,
data = filtered_barrera)
# Because species comes after |, it's being treated as a fixed effect
model_feols <- feols(at_msamean ~ T1_treat + T2_treat + s_teneviv + s_utilities + s_durables + s_infraest_hh + s_age_sorteo + s_age_sorteo2 + s_years_back + s_sexo + s_estcivil + s_single + s_edadhead + s_yrshead + s_tpersona + s_num18 + s_estrato + s_puntaje + s_ingtotal + grade + suba + s_over_age + school_code | school_code,
vcov = "hetero",
data = filtered_barrera)
tidy(model_feols)
# Look at relationship between fitted values and residuals
ggplot(fitted_data, aes(x = .fitted, y = .resid)) +
geom_point(aes(color = suba)) +
geom_smooth(method = "lm")
# Look at relationship between fitted values and residuals
ggplot(fitted_data, aes(x = .fitted, y = .resid)) +
geom_point(aes(color = grade)) +
geom_smooth(method = "lm")
# Because species comes after |, it's being treated as a fixed effect
model_feols <- feols(at_msamean ~ T1_treat + T2_treat + s_teneviv + s_utilities + s_durables + s_infraest_hh + s_age_sorteo + s_age_sorteo2 + s_years_back + s_sexo + s_estcivil + s_single + s_edadhead + s_yrshead + s_tpersona + s_num18 + s_estrato + s_puntaje + s_ingtotal + grade + s_over_age + school_code | school_code,
vcov = "hetero",
data = filtered_barrera)
tidy(model_feols)
# Because species comes after |, it's being treated as a fixed effect
model_feols <- feols(at_msamean ~ T1_treat + T2_treat + s_teneviv + s_utilities + s_durables + s_infraest_hh + s_age_sorteo + s_age_sorteo2 + s_years_back + s_sexo + s_estcivil + s_single + s_edadhead + s_yrshead + s_tpersona + s_num18 + s_estrato + s_puntaje + s_ingtotal + grade + s_over_age,
vcov = "hetero",
data = filtered_barrera)
tidy(model_feols)
tidy(model_feols)
# Running above model but with this as outcome
library(clusterSEs) # to get augment method for lm.cluster
# Running above model but with this as outcome
library(clusterSEs) # to get augment method for lm.cluster
mod_bi <- lm.cluster(data = filtered_barrera, above_cutoff ~ T1_treat + T2_treat + f_teneviv + s_utilities + s_durables + s_infraest_hh + s_age_sorteo + s_age_sorteo2 + s_years_back + s_sexo + f_estcivil + s_single + s_edadhead + s_yrshead + s_tpersona + s_num18 + f_estrato + s_puntaje + s_ingtotal + f_grade + suba + s_over_age + factor(school_code),  cluster = "school_code")
summary(mod_bi)
fitted_data <- augment(mod_bi, data = filtered_barrera)
?clusterSE
mod_bi <- lm(data = filtered_barrera, above_cutoff ~ T1_treat + T2_treat + f_teneviv + s_utilities + s_durables + s_infraest_hh + s_age_sorteo + s_age_sorteo2 + s_years_back + s_sexo + f_estcivil + s_single + s_edadhead + s_yrshead + s_tpersona + s_num18 + f_estrato + s_puntaje + s_ingtotal + f_grade + suba + s_over_age + factor(school_code),  cluster = "school_code")
summary(mod_bi)
fitted_data <- augment(mod_bi, data = filtered_barrera)
fitted_bi <- augment(mod_bi, data = filtered_barrera)
ggplot(fitted_bi, aes(x = .resid)) +
geom_histogram(binwidth = 0.01, color = "white", boundary = 50000)
mod_bi <- glm(data = filtered_barrera, above_cutoff ~ T1_treat + T2_treat + f_teneviv + s_utilities + s_durables + s_infraest_hh + s_age_sorteo + s_age_sorteo2 + s_years_back + s_sexo + f_estcivil + s_single + s_edadhead + s_yrshead + s_tpersona + s_num18 + f_estrato + s_puntaje + s_ingtotal + f_grade + suba + s_over_age + factor(school_code),  cluster = "school_code", family = binomial())
mod_bi <- glm(data = filtered_barrera, above_cutoff ~ T1_treat + T2_treat + f_teneviv + s_utilities + s_durables + s_infraest_hh + s_age_sorteo + s_age_sorteo2 + s_years_back + s_sexo + f_estcivil + s_single + s_edadhead + s_yrshead + s_tpersona + s_num18 + f_estrato + s_puntaje + s_ingtotal + f_grade + suba + s_over_age + factor(school_code), family = binomial())
summary(mod_bi)
fitted_bi <- augment(mod_bi, data = filtered_barrera)
ggplot(fitted_bi, aes(x = .resid)) +
geom_histogram(binwidth = 0.01, color = "white", boundary = 50000)
mod_gau <- lm(data = filtered_barrera, at_msamean ~ T1_treat + T2_treat + f_teneviv + s_utilities + s_durables + s_infraest_hh + s_age_sorteo + s_age_sorteo2 + s_years_back + s_sexo + f_estcivil + s_single + s_edadhead + s_yrshead + s_tpersona + s_num18 + f_estrato + s_puntaje + s_ingtotal + f_grade + suba + s_over_age + factor(school_code), family = gaussian())
summary(mod_gau)
fitted_gau <- augment(mod_gau, data = filtered_barrera)
ggplot(fitted_gau, aes(x = .resid)) +
geom_histogram(binwidth = 0.01, color = "white", boundary = 50000)
mod_gau <- glm(data = filtered_barrera, at_msamean ~ T1_treat + T2_treat + f_teneviv + s_utilities + s_durables + s_infraest_hh + s_age_sorteo + s_age_sorteo2 + s_years_back + s_sexo + f_estcivil + s_single + s_edadhead + s_yrshead + s_tpersona + s_num18 + f_estrato + s_puntaje + s_ingtotal + f_grade + suba + s_over_age + factor(school_code), family = gaussian())
summary(mod_gau)
mod_bi <- glm(data = filtered_barrera, above_cutoff ~ T1_treat + T2_treat + f_teneviv + s_utilities + s_durables + s_infraest_hh + s_age_sorteo + s_age_sorteo2 + s_years_back + s_sexo + f_estcivil + s_single + s_edadhead + s_yrshead + s_tpersona + s_num18 + f_estrato + s_puntaje + s_ingtotal + f_grade + suba + s_over_age + factor(school_code), family = binomial())
summary(mod_bi)
# Running above model but with this as outcome
library(clusterSEs) # to get augment method for lm.cluster
mod_bi <- glm(data = filtered_barrera, above_cutoff ~ T1_treat + T2_treat + f_teneviv + s_utilities + s_durables + s_infraest_hh + s_age_sorteo + s_age_sorteo2 + s_years_back + s_sexo + f_estcivil + s_single + s_edadhead + s_yrshead + s_tpersona + s_num18 + f_estrato + s_puntaje + s_ingtotal + f_grade + suba + s_over_age + factor(school_code), family = binomial())
summary(mod_bi)
fitted_bi <- augment(mod_bi, data = filtered_barrera)
plot_bi <- ggplot(fitted_bi, aes(x = .resid)) +
geom_histogram(binwidth = 0.01, color = "white", boundary = 50000)
mod_gau <- glm(data = filtered_barrera, at_msamean ~ T1_treat + T2_treat + f_teneviv + s_utilities + s_durables + s_infraest_hh + s_age_sorteo + s_age_sorteo2 + s_years_back + s_sexo + f_estcivil + s_single + s_edadhead + s_yrshead + s_tpersona + s_num18 + f_estrato + s_puntaje + s_ingtotal + f_grade + suba + s_over_age + factor(school_code), family = gaussian())
summary(mod_gau)
fitted_gau <- augment(mod_gau, data = filtered_barrera)
plot_gau <- ggplot(fitted_gau, aes(x = .resid)) +
geom_histogram(binwidth = 0.01, color = "white", boundary = 50000)
library(gridExtra) # to show two plots next to each other - I know there is another way!
# arrange plots side by side
grid.arrange(plot_by, plot_gau, ncol = 2)
# arrange plots side by side
grid.arrange(plot_bi, plot_gau, ncol = 2)
plot_gau <- ggplot(fitted_gau, aes(x = .resid)) +
geom_histogram(binwidth = 0.01, color = "white", boundary = 50000)
plot_gau
plot_bi
# arrange plots side by side
grid.arrange(plot_bi, plot_gau, nrow = 2)
# Running above model but with this as outcome
library(clusterSEs) # to get augment method for lm.cluster
mod_bi <- glm(data = filtered_barrera, above_cutoff ~ T1_treat + T2_treat + f_teneviv + s_utilities + s_durables + s_infraest_hh + s_age_sorteo + s_age_sorteo2 + s_years_back + s_sexo + f_estcivil + s_single + s_edadhead + s_yrshead + s_tpersona + s_num18 + f_estrato + s_puntaje + s_ingtotal + f_grade + suba + s_over_age + factor(school_code), family = binomial())
summary(mod_bi)
vcov <- vcovCL(mod_bi, cluster = filtered_barrera$school_code)
coeftest(mod_bi, vcov = vcov)
mod_gau <- glm(data = filtered_barrera, at_msamean ~ T1_treat + T2_treat + f_teneviv + s_utilities + s_durables + s_infraest_hh + s_age_sorteo + s_age_sorteo2 + s_years_back + s_sexo + f_estcivil + s_single + s_edadhead + s_yrshead + s_tpersona + s_num18 + f_estrato + s_puntaje + s_ingtotal + f_grade + suba + s_over_age + factor(school_code), family = gaussian())
summary(mod_gau)
vcov <- vcovCL(mod_gau, cluster = filtered_barrera$school_code)
coeftest(mod_gau, vcov = vcov)
fitted_gau <- augment(mod_gau, data = filtered_barrera)
#fitted_gau <- augment(mod_gau, data = filtered_barrera)
fitted_gau <- augment(mod_gau, data = filtered_barrera, se = vcov, type.predict = "response")
mod_gau <- glm(data = filtered_barrera, at_msamean ~ T1_treat + T2_treat + f_teneviv + s_utilities + s_durables + s_infraest_hh + s_age_sorteo + s_age_sorteo2 + s_years_back + s_sexo + f_estcivil + s_single + s_edadhead + s_yrshead + s_tpersona + s_num18 + f_estrato + s_puntaje + s_ingtotal + f_grade + suba + s_over_age + factor(school_code), family = gaussian())
summary(mod_gau)
vcov <- vcovCL(mod_gau, cluster = filtered_barrera$school_code)
coeftest(mod_gau, vcov = vcov)
#fitted_gau <- augment(mod_gau, data = filtered_barrera)
fitted_gau <- augment(mod_gau, data = filtered_barrera, se = vcov, type.predict = "response")
#fitted_gau <- augment(mod_gau, data = filtered_barrera)
fitted_gau <- augment(mod_gau, data = filtered_barrera, se = vcov)
library(sandwich)
library(broom)
mod_gau <- glm(data = filtered_barrera, at_msamean ~ T1_treat + T2_treat + f_teneviv + s_utilities + s_durables + s_infraest_hh + s_age_sorteo + s_age_sorteo2 + s_years_back + s_sexo + f_estcivil + s_single + s_edadhead + s_yrshead + s_tpersona + s_num18 + f_estrato + s_puntaje + s_ingtotal + f_grade + suba + s_over_age + factor(school_code), family = gaussian())
summary(mod_gau)
vcov <- vcovCL(mod_gau, cluster = filtered_barrera$school_code)
coeftest(mod_gau, vcov = vcov)
#fitted_gau <- augment(mod_gau, data = filtered_barrera)
fitted_gau <- augment(mod_gau, data = filtered_barrera, se = vcov)
?augment
#fitted_gau <- augment(mod_gau, data = filtered_barrera)
fitted_gau <- augment(mod_gau, data = filtered_barrera, se_fit = vcov)
#fitted_gau <- augment(mod_gau, data = filtered_barrera)
fitted_gau <- augment(mod_gau, data = filtered_barrera, se_fit = TRUE)
plot_gau <- ggplot(fitted_gau, aes(x = .resid)) +
geom_histogram(binwidth = 0.01, color = "white", boundary = 50000)
plot_gau
coeftest(mod_bi, vcov = vcov)
fitted_bi <- augment(mod_bi, type = residuals, se_fit = TRUE)
fitted_bi <- augment(mod_bi, type = "residuals", se_fit = TRUE)
# Running above model but with this as outcome --> note that the residual plots don't pick up the clustered standard errors.
library(clusterSEs) # to get augment method for lm.cluster
library(sandwich)
library(broom) # augment for glm
mod_bi <- glm(data = filtered_barrera, above_cutoff ~ T1_treat + T2_treat + f_teneviv + s_utilities + s_durables + s_infraest_hh + s_age_sorteo + s_age_sorteo2 + s_years_back + s_sexo + f_estcivil + s_single + s_edadhead + s_yrshead + s_tpersona + s_num18 + f_estrato + s_puntaje + s_ingtotal + f_grade + suba + s_over_age + factor(school_code), family = binomial())
summary(mod_bi)
vcov <- vcovCL(mod_bi, cluster = filtered_barrera$school_code)
coeftest(mod_bi, vcov = vcov)
fitted_bi <- augment(mod_bi, type = "residuals", se_fit = TRUE)
fitted_bi <- augment(mod_bi, data = filtered_barrera, type = "residuals", se_fit = TRUE)
fitted_bi <- augment(mod_bi, data = filtered_barrera, type = "residuals")
tidy(mod_bi)
mod_bi <- glm(data = filtered_barrera, above_cutoff ~ T1_treat + T2_treat + f_teneviv + s_utilities + s_durables + s_infraest_hh + s_age_sorteo + s_age_sorteo2 + s_years_back + s_sexo + f_estcivil + s_single + s_edadhead + s_yrshead + s_tpersona + s_num18 + f_estrato + s_puntaje + s_ingtotal + f_grade + suba + s_over_age + factor(school_code), family = binomial())
summary(mod_bi)
vcov <- vcovCL(mod_bi, cluster = filtered_barrera$school_code)
coeftest(mod_bi, vcov = vcov)
# Get residuals with clustered standard errors
tidy_bi <- tidy(mod_bi)
residuals_bi <- augment(mod_bi, type.predict = "response") %>%
mutate(se_fit = sqrt(resid.var)) %>%
mutate(cluster = filtered_barrera$school_code) %>%
group_by(cluster) %>%
mutate(se_fit = sqrt(wtd.var(residuals(se_fit, fitted(mod_bi)), weights = weights))) %>%
mutate(resid_se = se_fit * abs(rstudent(mod_bi, type = "HC1")))
fitted_bi <- augment(mod_bi, data = filtered_barrera, se_fit = TRUE)
mod_bi <- glm(data = filtered_barrera, above_cutoff ~ T1_treat + T2_treat + f_teneviv + s_utilities + s_durables + s_infraest_hh + s_age_sorteo + s_age_sorteo2 + s_years_back + s_sexo + f_estcivil + s_single + s_edadhead + s_yrshead + s_tpersona + s_num18 + f_estrato + s_puntaje + s_ingtotal + f_grade + suba + s_over_age + factor(school_code), family = binomial())
summary(mod_bi)
vcov <- vcovCL(mod_bi, cluster = filtered_barrera$school_code)
coeftest(mod_bi, vcov = vcov)
fitted_bi <- augment(mod_bi, data = filtered_barrera, se_fit = TRUE)
plot_bi <- ggplot(fitted_bi, aes(x = .resid)) +
geom_histogram(binwidth = 0.01, color = "white", boundary = 50000)
plot_bi
