---
title: "Barrera-Osorio et al 2011"
author: "Dimitrios & Eva"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: yes
    toc_depth: '1'
    df_print: paged
  pdf_document:
    toc: yes
    toc_depth: 1
    number_sections: yes



---

\newpage


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)




```






```{r data_prep}



# Filtering data in line with the following STATA code operations to reproduce table 4, columns 4-6:
# Same as above, but suba == 1 and in rade 9 or 10

filtered_barrera2 <- barrera %>% filter(suba == 1, survey_selected == 1, grade >= 9, grade <= 10)

# For table 4, just results, not procedure

```




```{r mod0, echo = TRUE}



```



```{r outcome_var, echo = TRUE}



```





```{r table1}



```








```{r models}



feols_m1 <- feols(data = filtered_barrera,
               at_msamean ~ T1_treat + T2_treat,
               cluster = ~ school_code)

feols_m2 <- feols(data = filtered_barrera, 
                  at_msamean ~ T1_treat + T2_treat + f_teneviv + s_utilities + s_durables + s_infraest_hh + s_age_sorteo + s_age_sorteo2 + s_years_back + s_sexo + f_estcivil + s_single + s_edadhead + s_yrshead + s_tpersona + s_num18 + f_estrato + s_puntaje + s_ingtotal + f_grade + suba + s_over_age,
                  cluster = ~ school_code)

feols_m3 <- feols(data = filtered_barrera, 
                  at_msamean ~ T1_treat + T2_treat + f_teneviv + s_utilities + s_durables + s_infraest_hh + s_age_sorteo + s_age_sorteo2 + s_years_back + s_sexo + f_estcivil + s_single + s_edadhead + s_yrshead + s_tpersona + s_num18 + f_estrato + s_puntaje + s_ingtotal + f_grade + suba + s_over_age | school_code,
                  cluster = ~ school_code)

# specify hypothesis tests

hyp1 <- linearHypothesis(feols_m1, "T1_treat - T2_treat = 0")
hyp2 <- linearHypothesis(feols_m2, "T1_treat - T2_treat")
hyp3 <- linearHypothesis(feols_m3, "T1_treat - T2_treat")

# Save results and format separately from coefficients - there's probably a more elegant way.
chi1 <- format(round(hyp1[,2][2], 2), nsmall = 2)
chi2 <- format(round(hyp2[,2][2], 2), nsmall = 2)
chi3 <- format(round(hyp3[,2][2], 2), nsmall = 2)
p1 <- format(round(hyp1[,3][2], 2), nsmall = 2)
p2 <- format(round(hyp2[,3][2], 2), nsmall = 2)
p3 <- format(round(hyp3[,3][2], 2), nsmall = 2)

rows <- tribble(~term, ~"(1)", ~"(2)", ~"(3)",
                "Chi-squared", chi1, chi2, chi3,
                "p-value", p1, p2, p3)
attr(rows, "position") <- c(5,6)

# Adding grouping label to hypothesis test results and grouped column header, also footnotes.


# Combining all model outputs into one table and showing only coefficients on T1_treat and T2_treat

modelsummary(list(feols_m1, feols_m2, feols_m3),
             coef_omit = -c(2,3),
             gof_omit = "AIC|BIC|RMSE|R2 W|R2 A",
             stars = TRUE,
             add_rows = rows,
             coef_rename = c("Basic treatment","Savings treatment"),
             title = "Table 3 - Effects on Monitored School Attendance Rates",
             output = "markdown"
             ) |>
             kable_styling(latex_options = "striped") |> pack_rows(index = c(" " = 4, "Hypothesis: Basic - Savings" = 2)) |>
                                                        add_header_above(c(" " = 1, "Basic - Savings" = 3)) |>
                                                                           footnote(general = "We've created a footnote.",
                                                                                    number = c("Footnote 1", "Footnote 2"))

# The table looks ok, but the R-squared should only have two digits after the decimal point. May be possible with gof_map.

```






# Some exploration

Part of the problem with this model is the outcome variable, which has a ceiling effect (can't go above 100%, and many people have high attendance, with target attendance also being high at 80%.)


It may be worthwhile investigating whether there is a significant difference in the proportion above the cut-off between samples.

```{r expl, echo = TRUE}

# Create separate cumulative distribution plots of at_msamean for each level of T1T2T3

ggplot(filtered_barrera, aes(x = at_msamean)) +
  stat_ecdf(aes(color = T1T2T3)) +
  labs(x = "at_msamean", y = "Cumulative Probability") +
  facet_wrap(~T1T2T3, ncol = 3) +
  geom_vline(xintercept = 0.8, color = "red", linetype = "dashed") +
  theme(panel.border = element_rect(colour = "black", fill = NA, linewidth = 1),
        panel.spacing = unit(0.5, "lines"))



# What proportion in each group falls at or above the target of 80% attendance?

cutoff <- 0.8  # set the cutoff value

filtered_barrera %>% 
  group_by(T1T2T3) %>% 
  summarize(prop_cutoff = sum(at_msamean >= cutoff) / n())

```

Variability in the outcome variable is limited because most students attend at least 80% of the time. An alternative model specification may be to analyse differences in proportion of attendance (above / below cut-off).




Alternative way of approaching this:
GLM for skewed data (e.g. log link and gamma function --> would need to fit this more carefully, )
Binary variable: Whether or not student achieved 80% attendance



```{r exploration, echo = FALSE}
# Calculating new column: is at or above cut-off?


filtered_barrera <- filtered_barrera %>% 
  mutate(above_cutoff = ifelse(at_msamean >= cutoff, 1, 0))

# Running above model but with this as outcome --> note that the residual plots don't pick up the clustered standard errors.
library(clusterSEs) # to get augment method for lm.cluster
library(sandwich)
library(broom) # augment for glm

mod_bi <- glm(data = filtered_barrera, above_cutoff ~ T1_treat + T2_treat + f_teneviv + s_utilities + s_durables + s_infraest_hh + s_age_sorteo + s_age_sorteo2 + s_years_back + s_sexo + f_estcivil + s_single + s_edadhead + s_yrshead + s_tpersona + s_num18 + f_estrato + s_puntaje + s_ingtotal + f_grade + suba + s_over_age + factor(school_code), family = binomial())
summary(mod_bi)
vcov <- vcovCL(mod_bi, cluster = filtered_barrera$school_code)
coeftest(mod_bi, vcov = vcov)


fitted_bi <- augment(mod_bi, data = filtered_barrera, se_fit = TRUE)

plot_bi <- ggplot(fitted_bi, aes(x = .resid)) +
  geom_histogram(binwidth = 0.01, color = "white", boundary = 50000)
plot_bi

# To compare, running linear model as glm:

mod_gau <- glm(data = filtered_barrera, at_msamean ~ T1_treat + T2_treat + f_teneviv + s_utilities + s_durables + s_infraest_hh + s_age_sorteo + s_age_sorteo2 + s_years_back + s_sexo + f_estcivil + s_single + s_edadhead + s_yrshead + s_tpersona + s_num18 + f_estrato + s_puntaje + s_ingtotal + f_grade + suba + s_over_age + factor(school_code), family = gaussian())
summary(mod_gau)
vcov <- vcovCL(mod_gau, cluster = filtered_barrera$school_code)
coeftest(mod_gau, vcov = vcov)

#fitted_gau <- augment(mod_gau, data = filtered_barrera)
fitted_gau <- augment(mod_gau, data = filtered_barrera, se_fit = TRUE)


plot_gau <- ggplot(fitted_gau, aes(x = .resid)) +
  geom_histogram(binwidth = 0.01, color = "white", boundary = 50000)
plot_gau

library(gridExtra) # to show two plots next to each other - I know there is another way!
# arrange plots side by side
grid.arrange(plot_bi, plot_gau, nrow = 2)

```

GLM with binary outcome variable performs much better on AIC. But I'm not sure the residual plots help us very much as it's not clustered SE!





# Conclusion

- Replication of a research paper: How do results compare to results of research paper?

Models all bad, R-sq low.


Compare coefficients, standard errors
Why might they be different?
* Software: Possible to get STATA standard errors in R



Source for clustered standard errors in R: https://evalf21.classes.andrewheiss.com/example/standard-errors/





