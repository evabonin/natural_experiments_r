---
title: "Barrera-Osorio et al 2011"
author: "Dimitrios & Eva"
date: "`r Sys.Date()`"
output: 
  powerpoint_presentation:
    toc: true
    toc_depth: 1
    number_sections: true
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)

# packages

library(knitrBootstrap)
library(dplyr)
library(haven)
library(table1)
library(sjPlot)
library(sjmisc)
library(sjlabelled)


```



# Motivation

- Why is this research question relevant?
- What are the main hypotheses?


# Data sources

- Where does the data come from (country, time period, source)?
- What are the key variables?
- How are these measured?

# Method

- What are the assumptions of the method?
- Are these assumptions plausible in this example?
- Maybe: regression equation.




```{r data_prep, echo = FALSE}

# Importing STATA file

barrera <- read_dta("data/Public_Data_AEJApp_2010-0132.dta")

# Turning variables into factor variables. Following STATA convention.

barrera$f_teneviv <- factor(barrera$s_teneviv)
barrera$f_estcivil <- factor(barrera$s_estcivil, levels = c(1, 2, 3, 4, 5), labels = c("Free union", "Married", "Widow(er)", "Divorced", "Single"))
barrera$f_estrato <- factor(barrera$s_estrato)
barrera$f_grade <- factor(barrera$grade)
barrera$f_sexo <- factor(barrera$s_sexo, levels = c(0,1), labels = c("Female", "Male"))
barrera$f_single <- factor(barrera$s_single, levels = c(0,1), labels = c("No", "Yes"))
barrera$f_over_age <- factor(barrera$s_over_age, levels = c(0,1), labels = c("No", "Yes"))
barrera$f_suba <- factor(barrera$suba, levels = c(0,1), labels = c("San Cristobal", "Suba"))




# Generate one variable to capture treatment assignment (T1, T2, control)

barrera$T1T2T3 <- case_when(
  barrera$T1_treat == 1 ~ 1,
  barrera$T2_treat == 1 ~ 2,
  barrera$T3_treat == 1 ~ 3,
  barrera$T1_treat == 0 & barrera$T2_treat == 0 & barrera$T3_treat == 0 ~ 0
)

barrera$T1T2T3 <- factor(barrera$T1T2T3, level = c(0, 1, 2, 3), labels = c("Control", "Basic (T1)", "Savings (T2)", "Tertiary (T3"))


# Confirm that this worked

attach(barrera)
check_table <- table(T1T2T3, T1_treat, T2_treat, T3_treat)
ftable(check_table)



# Filtering data in line with the following STATA code operations to reproduce table 3, columns 1-3:
# Dropping ineligible cases from Suba: Drop if suba == 1 and grade is < 9
# drop if suba == 1 & grade < 9; 
# The above seems to be a mistake in the STATA code: this should be grade < 6 instead of < 9. 
# Keeping only those who were selected for the survey:
# keep if survey_selected;
# Drop if they are in grade 11


# Filtered data

filtered_barrera <- barrera %>% filter(suba == 0, grade >= 6, survey_selected == 1, grade != 11)


# Filtering data in line with the following STATA code operations to reproduce table 3, columns 4-6:
# Same as above, but suba == 1 and in rade 9 or 10

filtered_barrera2 <- barrera %>% filter(suba == 1, survey_selected == 1, grade >= 9, grade <= 10)


```





# Descriptive statistics

- Describe sample



```{r table1, echo = TRUE}


# Using n = 5,799 to get the sample actually used in our model (for columns 1-3). Variables selected based on Table 1.
# Note: Some factor variables are presented in the paper as scale vars.

# House posessions - f_teneviv
# utilities - s_utilities
# durable goods - s_durables
# physical infrastructure - s_infraest_hh
# age - s_age_sorteo
# gender - s_sexo
# years of education - s_yrs
# single head - s_single
# Age of head - s_edadhead
# years of ed head - s_yrshead
# people in household - s_tpersona
# Member under 18 - s_num18
# estrato - f_estrato
# SISBEN - s_puntaje
# household income - s_ingtotal







table1 <- table1(~ factor(f_teneviv) + s_utilities + s_durables + s_infraest_hh + s_age_sorteo + factor(f_sexo) + s_yrs + factor(f_single) + s_edadhead + s_yrshead + s_tpersona + s_num18 + factor(f_estrato) + s_puntaje + s_ingtotal | ~ factor(T1T2T3), data=filtered_barrera)

```

table1


```{r a, echo = FALSE}


```


# Results

- Are these results plausible?
- How robust are the results to changing the sample?

```{r models, echo = FALSE}

mod1 <- miceadds::lm.cluster(data = filtered_barrera, at_msamean ~ T1_treat + T2_treat,  cluster = "school_code")

summary(mod1)


mod2 <- miceadds::lm.cluster(data = filtered_barrera, at_msamean ~ T1_treat + T2_treat + f_teneviv + s_utilities + s_durables + s_infraest_hh + s_age_sorteo + s_age_sorteo2 + s_years_back + s_sexo + f_estcivil + s_single + s_edadhead + s_yrshead + s_tpersona + s_num18 + f_estrato + s_puntaje + s_ingtotal + f_grade + suba + s_over_age,  cluster = "school_code")

summary(mod2)


mod3 <- miceadds::lm.cluster(data = filtered_barrera, at_msamean ~ T1_treat + T2_treat + f_teneviv + s_utilities + s_durables + s_infraest_hh + s_age_sorteo + s_age_sorteo2 + s_years_back + s_sexo + f_estcivil + s_single + s_edadhead + s_yrshead + s_tpersona + s_num18 + f_estrato + s_puntaje + s_ingtotal + f_grade + suba + s_over_age + factor(school_code),  cluster = "school_code")

summary(mod3)


mod4 <- miceadds::lm.cluster(data = filtered_barrera2, at_msamean ~ T3_treat,  cluster = "school_code")

summary(mod4)


mod5 <- miceadds::lm.cluster(data = filtered_barrera2, at_msamean ~ T3_treat + f_teneviv + s_utilities + s_durables + s_infraest_hh + s_age_sorteo + s_age_sorteo2 + s_years_back + s_sexo + f_estcivil + s_single + s_edadhead + s_yrshead + s_tpersona + s_num18 + f_estrato + s_puntaje + s_ingtotal + f_grade + suba + s_over_age,  cluster = "school_code")

summary(mod5)


mod6 <- miceadds::lm.cluster(data = filtered_barrera2, at_msamean ~ T3_treat + + f_teneviv + s_utilities + s_durables + s_infraest_hh + s_age_sorteo + s_age_sorteo2 + s_years_back + s_sexo + f_estcivil + s_single + s_edadhead + s_yrshead + s_tpersona + s_num18 + f_estrato + s_puntaje + s_ingtotal + f_grade + suba + s_over_age + factor(school_code),  cluster = "school_code")

summary(mod6)




```


# Conclusion

- Replication of a research paper: How do results compare to results of research paper?


```{r b, echo = FALSE}


```

Source for clustered standard errors in R: https://evalf21.classes.andrewheiss.com/example/standard-errors/

fixef(lmer(Reaction ~ Days + (1|Subject) + (0+Days|Subject), sleepstudy))



